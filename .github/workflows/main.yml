name: üöÄ SERVER AI STV PREMIUM - RUSTDESK EDITION

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER CH√ÄO M·ª™NG
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ AI STV PREMIUM RDP SERVER - RUSTDESK" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV - K·∫øt n·ªëi m∆∞·ª£t nh∆∞ TeamViewer!" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          
          # Hi·ªáu ·ª©ng loading
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!                    " -ForegroundColor Green

      # C·∫§U H√åNH N√ÇNG CAO (gi·ªØ nguy√™n RDP n·∫øu c·∫ßn fallback)
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="B·∫≠t Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="T·∫Øt x√°c th·ª±c m·∫°ng"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="C·∫•u h√¨nh b·∫£o m·∫≠t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
              }},
              @{Name="M·ªü port firewall c·∫ßn thi·∫øt"; Script={
                  netsh advfirewall firewall add rule name="RustDesk-Direct" dir=in action=allow protocol=TCP localport=21118 profile=any
                  netsh advfirewall firewall add rule name="RDP-Fallback" dir=in action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Kh·ªüi ƒë·ªông d·ªãch v·ª•"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ b·ªè qua l·ªói nh·ªè" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "üéØ C·∫•u h√¨nh ho√†n t·∫•t!" -ForegroundColor Green

      # T·∫†O USER PREMIUM
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          # (Gi·ªØ nguy√™n ph·∫ßn t·∫°o user nh∆∞ c≈©)
          Write-Host ""
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          
          function New-PremiumPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          try {
              Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          } catch {}

          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Enable-LocalUser -Name "AISTV-PREMIUM"
          
          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          
          Write-Host "‚úÖ T√†i kho·∫£n: AISTV-PREMIUM ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      # C√ÄI ƒê·∫∂T RUSTDESK (s·ª≠ d·ª•ng public server ƒë·ªÉ d·ªÖ k·∫øt n·ªëi direct, kh√¥ng c·∫ßn Tailscale)
      - name: üñ•Ô∏è C√ÄI ƒê·∫∂T RUSTDESK PREMIUM
        run: |
          Write-Host ""
          Write-Host "üñ•Ô∏è ƒêANG C√ÄI ƒê·∫∂T RUSTDESK - K·∫æT N·ªêI M∆Ø·ª¢T M√Ä" -ForegroundColor Yellow
          
          # T·∫£i phi√™n b·∫£n m·ªõi nh·∫•t (1.4.4 t·∫°i th·ªùi ƒëi·ªÉm hi·ªán t·∫°i)
          $rustdeskUrl = "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.exe"
          $exePath = "$env:TEMP\rustdesk.exe"
          Invoke-WebRequest -Uri $rustdeskUrl -OutFile $exePath
          
          # C√†i silent
          Start-Process $exePath -ArgumentList "--silent-install" -Wait
          
          # Ch·ªù kh·ªüi ƒë·ªông d·ªãch v·ª•
          Start-Sleep -Seconds 15
          
          # L·∫•y ID RustDesk (ch·∫°y d∆∞·ªõi admin)
          $rustdeskPath = "$env:ProgramFiles\RustDesk\rustdesk.exe"
          $rustdeskID = & $rustdeskPath --get-id
          if (-not $rustdeskID) {
              Write-Host "‚îÇ ‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c ID, th·ª≠ l·∫°i..." -ForegroundColor Yellow
              Start-Sleep -Seconds 5
              $rustdeskID = & $rustdeskPath --get-id
          }
          
          # Sinh password RustDesk ng·∫´u nhi√™n (8 k√Ω t·ª± m·∫°nh)
          $rustPass = New-PremiumPassword
          & $rustdeskPath --password $rustPass
          
          echo "RUSTDESK_ID=$rustdeskID" >> $env:GITHUB_ENV
          echo "RUSTDESK_PASS=$rustPass" >> $env:GITHUB_ENV
          
          Write-Host "‚îÇ ‚úÖ RustDesk ID: $rustdeskID" -ForegroundColor Green
          Write-Host "‚îÇ ‚úÖ RustDesk Password: $rustPass" -ForegroundColor Green
          Write-Host "üéØ RustDesk ƒë√£ s·∫µn s√†ng - K·∫øt n·ªëi si√™u m∆∞·ª£t t·ª´ app iPhone!" -ForegroundColor Green

      # HI·ªÇN TH·ªä GIAO DI·ªÜN ƒê·∫∏P (∆∞u ti√™n RustDesk)
      - name: üéâ TH√îNG TIN K·∫æT N·ªêI PREMIUM
        run: |
          $rdpPass = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if (-not $rdpPass) { $rdpPass = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c" }
          
          # Th·ªùi gian
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60; $displayTime = "1 gi·ªù" }
              "3h" { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "5h40m" { $totalMinutes = 340; $displayTime = "5 gi·ªù 40 ph√∫t" }
          }
          
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ           üéâ K·∫æT N·ªêI RUSTDESK TH√ÄNH C√îNG!         ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üÜî  RustDesk ID: $env:RUSTDESK_ID" -ForegroundColor White
          Write-Host "‚îÇ üîê  Password: $env:RUSTDESK_PASS" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Th·ªùi l∆∞·ª£ng: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üïê  B·∫Øt ƒë·∫ßu: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "‚îÇ üïê  K·∫øt th√∫c: $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üí°  H∆∞·ªõng d·∫´n k·∫øt n·ªëi (∆∞u ti√™n):                  ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îÇ   1. T·∫£i app RustDesk tr√™n iPhone (App Store)     ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   2. Nh·∫≠p ID: $env:RUSTDESK_ID                    ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   3. Nh·∫≠p Password: $env:RUSTDESK_PASS           ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   4. K·∫øt n·ªëi m∆∞·ª£t m√†, kh√¥ng lag, gi·ªëng TeamViewer ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ                                           ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îÇ üìå Fallback RDP (n·∫øu c·∫ßn):                        ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îÇ   T√†i kho·∫£n: AISTV-PREMIUM | M·∫≠t kh·∫©u: $rdpPass   ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   Port: 3389                                      ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan
          
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      # DUY TR√å PHI√äN
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          # (Gi·ªØ nguy√™n ph·∫ßn monitor nh∆∞ c≈©, ch·ªâ thay Tailscale b·∫±ng RustDesk status n·∫øu c·∫ßn)
          $totalMinutes = $env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          
          Write-Host "üîÑ B·∫ÆT ƒê·∫¶U DUY TR√å PHI√äN - RUSTDESK READY" -ForegroundColor Yellow
          Write-Host "üÜî ID: $env:RUSTDESK_ID | üîê PASS: $env:RUSTDESK_PASS" -ForegroundColor Cyan
          
          # Monitor ƒë∆°n gi·∫£n
          $monitorScript = {
              while ($true) {
                  $currentTime = Get-Date
                  Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ‚ù§Ô∏è M√°y ƒëang online - RustDesk s·∫µn s√†ng!" -ForegroundColor Blue
                  Start-Sleep -Seconds 120
              }
          }
          Start-Job -ScriptBlock $monitorScript -Name "KeepAlive"
          
          # Timer countdown
          $frames = @('‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è')
          $colors = @('Red', 'Yellow', 'Green', 'Cyan', 'Blue', 'Magenta')
          $startTime = Get-Date
          
          do {
              $thoiGianHienTai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $thoiGianConLai = $thoiGianKetThuc - $thoiGianHienTai
              
              $gioConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalHours))
              $phutConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalMinutes % 60))
              $giayConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalSeconds % 60))
              
              $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
              $color = $colors[([int]((Get-Date) - $startTime).TotalMinutes) % $colors.Length]
              
              Write-Host "`r$frame [$($thoiGianHienTai.ToString('HH:mm:ss'))] Th·ªùi gian c√≤n l·∫°i: $gioConLai gi·ªù $phutConLai ph√∫t $giayConLai gi√¢y" -NoNewline -ForegroundColor $color
              
              Start-Sleep -Seconds 5
              
          } while ($thoiGianConLai.TotalSeconds -gt 0)
          
          Write-Host ""
          Write-Host "üéØ ƒê√É H·∫æT TH·ªúI GIAN - T·ª∞ ƒê·ªòNG D·ª™NG!" -ForegroundColor Red
          
          Get-Job -Name "KeepAlive" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

      # D·ªåN D·∫∏P
      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host ""
          Write-Host "üßπ ƒêANG D·ªåN D·∫∏P..." -ForegroundColor Yellow
          
          # G·ª° RustDesk
          $rustdeskPath = "$env:ProgramFiles\RustDesk\rustdesk.exe"
          if (Test-Path $rustdeskPath) {
              & $rustdeskPath --uninstall
          }
          
          # V√¥ hi·ªáu user, t·∫Øt RDP, x√≥a firewall rules...
          Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RustDesk-Direct" -ErrorAction SilentlyContinue
          netsh advfirewall firewall delete rule name="RDP-Fallback" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
          
          Write-Host "üéâ D·ªçn d·∫πp ho√†n t·∫•t! H·∫πn g·∫∑p l·∫°i! üëã" -ForegroundColor Green
